import 'package:flutter/material.dart';
import 'package:flutter/services.dart';

class PentestGuideScreen extends StatelessWidget {
  const PentestGuideScreen({super.key});

  final String targetIp = '115.133.118.216';
  final String clientName = 'Total SE Solutions Sdn Bhd (TSE)';

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(
        title: const Text('Pentest Methodology'),
        backgroundColor: Theme.of(context).colorScheme.inversePrimary,
      ),
      body: ListView(
        padding: const EdgeInsets.all(16.0),
        children: [
          _buildHeader(),
          const SizedBox(height: 16),
          _buildSection1(),
          _buildSection2(),
          _buildSection3(context),
          _buildSection4(context),
          _buildSection5(context),
          _buildSection6(context),
          _buildSection7(),
          _buildSection8(context),
          _buildSection9(),
          _buildSection10(),
          _buildSection11(),
          _buildSection12(context),
          _buildSection13(),
          _buildToolsSummary(),
          const SizedBox(height: 32),
        ],
      ),
    );
  }

  Widget _buildHeader() {
    return Card(
      color: Colors.blueGrey.shade50,
      elevation: 2,
      child: Padding(
        padding: const EdgeInsets.all(16.0),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            Text('Client: $clientName', style: const TextStyle(fontWeight: FontWeight.bold, fontSize: 16)),
            const SizedBox(height: 8),
            Text('Target IP: $targetIp', style: const TextStyle(fontSize: 20, fontWeight: FontWeight.w900, color: Colors.blue)),
            const SizedBox(height: 8),
            const Text('Assessment Type: External Black-Box Penetration Test'),
            const SizedBox(height: 8),
            const Text('Objective: Identify exposed services, open ports, and potential vulnerabilities on the external system.', style: TextStyle(fontStyle: FontStyle.italic)),
          ],
        ),
      ),
    );
  }

  Widget _buildSectionTitle(String title) {
    return Padding(
      padding: const EdgeInsets.symmetric(vertical: 12.0),
      child: Text(
        title,
        style: const TextStyle(fontSize: 18, fontWeight: FontWeight.bold, color: Colors.deepPurple),
      ),
    );
  }

  Widget _buildTextContent(String content) {
    return Padding(
      padding: const EdgeInsets.only(bottom: 8.0, left: 8.0),
      child: Text(content, style: const TextStyle(fontSize: 14, height: 1.4)),
    );
  }

  Widget _buildBulletPoint(String text) {
    return Padding(
      padding: const EdgeInsets.only(bottom: 4.0, left: 16.0),
      child: Row(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          const Text('• ', style: TextStyle(fontWeight: FontWeight.bold)),
          Expanded(child: Text(text)),
        ],
      ),
    );
  }

  Widget _buildSection1() {
    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        _buildSectionTitle('1. Introduction'),
        _buildTextContent('Penetration testing is an authorized security assessment where a tester simulates real‑world attacks to identify weaknesses before malicious actors exploit them.\nThis engagement follows a black‑box approach, meaning the tester only has public information such as the target IP address.'),
        const SizedBox(height: 8),
        const Text('Key Objectives:', style: TextStyle(fontWeight: FontWeight.bold)),
        _buildBulletPoint('Identify exposed network services'),
        _buildBulletPoint('Detect misconfigurations and outdated software'),
        _buildBulletPoint('Validate potential vulnerabilities'),
        _buildBulletPoint('Provide remediation recommendations'),
        const SizedBox(height: 8),
        const Text('Testing Flow:', style: TextStyle(fontWeight: FontWeight.bold)),
        _buildTextContent('Pre‑Engagement → Reconnaissance → Scanning & Enumeration → Vulnerability Assessment → Exploitation (if authorized) → Post‑Exploitation → Reporting → Remediation → Retest → Final Reporting'),
      ],
    );
  }

  Widget _buildSection2() {
    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        _buildSectionTitle('2. Pre‑Engagement Phase'),
        _buildTextContent('Purpose: Establish authorization, scope, and rules before testing.'),
        const Text('Activities:', style: TextStyle(fontWeight: FontWeight.bold)),
        _buildBulletPoint('Confirm target IP: $targetIp'),
        _buildBulletPoint('Define testing boundaries'),
        _buildBulletPoint('Agree on Rules of Engagement (ROE)'),
        _buildBulletPoint('Obtain written authorization'),
        const SizedBox(height: 4),
        const Text('Output:', style: TextStyle(fontWeight: FontWeight.bold)),
        _buildBulletPoint('Approved scope'),
        _buildBulletPoint('Formal testing permission'),
      ],
    );
  }

  Widget _buildSection3(BuildContext context) {
    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        _buildSectionTitle('3. Information Gathering (Reconnaissance)'),
        _buildTextContent('Purpose: Collect public information about the target.'),
        _buildCommandTile(context, '3.1 Host Availability Check', 'ping $targetIp'),
        _buildCommandTile(context, '3.2 WHOIS Lookup', 'whois $targetIp'),
        _buildCommandTile(context, '3.3 Reverse DNS Lookup', 'nslookup $targetIp'),
        _buildCommandTile(context, '3.4 Domain Enumeration', 'theHarvester -d <domain> -b all'),
        const SizedBox(height: 4),
        const Text('Outcome:', style: TextStyle(fontWeight: FontWeight.bold)),
        _buildBulletPoint('Host status'),
        _buildBulletPoint('Ownership details'),
        _buildBulletPoint('DNS exposure'),
      ],
    );
  }

  Widget _buildSection4(BuildContext context) {
    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        _buildSectionTitle('4. Scanning & Enumeration Phase'),
        _buildTextContent('Purpose: Discover open ports and services.'),
        _buildCommandTile(context, '4.1 Quick Port Scan', 'nmap -F $targetIp'),
        _buildCommandTile(context, '4.2 Full TCP Port Scan', 'nmap -p- $targetIp'),
        _buildCommandTile(context, '4.3 Service Version Detection', 'nmap -sV $targetIp'),
        _buildCommandTile(context, '4.4 OS Detection', 'sudo nmap -O $targetIp'),
        _buildCommandTile(context, '4.5 Script Scan', 'nmap -sC $targetIp'),
      ],
    );
  }

  Widget _buildSection5(BuildContext context) {
    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        _buildSectionTitle('5. Vulnerability Assessment Phase'),
        _buildTextContent('Purpose: Identify known vulnerabilities.'),
        _buildCommandTile(context, '5.1 Nmap Vulnerability Scan', 'nmap --script vuln $targetIp'),
        _buildCommandTile(context, '5.2 Web Checks', 'nikto -h http://$targetIp'),
        _buildCommandTile(context, '5.3 SSL/TLS Check', 'sslscan $targetIp'),
        const SizedBox(height: 4),
        const Text('Outcome:', style: TextStyle(fontWeight: FontWeight.bold)),
        _buildBulletPoint('Open ports'),
        _buildBulletPoint('Running services'),
        _buildBulletPoint('Possible vulnerabilities'),
      ],
    );
  }

  Widget _buildSection6(BuildContext context) {
    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        _buildSectionTitle('6. Exploitation Phase (Only if Authorized)'),
        _buildTextContent('Purpose: Confirm whether vulnerabilities are exploitable.'),
        _buildCommandTile(context, 'Example: SSH Login Test', 'hydra -l root -P /usr/share/wordlists/rockyou.txt ssh://$targetIp'),
        _buildCommandTile(context, 'Example: Metasploit Usage', 'msfconsole'),
      ],
    );
  }

  Widget _buildSection7() {
    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        _buildSectionTitle('7. Post‑Exploitation Phase (If Access Gained)'),
        _buildTextContent('Purpose: Assess attacker impact.'),
        const Text('Activities:', style: TextStyle(fontWeight: FontWeight.bold)),
        _buildBulletPoint('Identify sensitive files'),
        _buildBulletPoint('Check user privileges'),
        _buildBulletPoint('Assess lateral movement possibilities'),
      ],
    );
  }

  Widget _buildSection8(BuildContext context) {
    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        _buildSectionTitle('8. Documentation Phase'),
        _buildTextContent('Purpose: Record all findings.'),
        _buildCommandTile(context, 'Save Scan Results', 'nmap -oA scan_results $targetIp'),
        const SizedBox(height: 4),
        const Text('Generated files:', style: TextStyle(fontWeight: FontWeight.bold)),
        _buildBulletPoint('.nmap'),
        _buildBulletPoint('.xml'),
        _buildBulletPoint('.gnmap'),
      ],
    );
  }

  Widget _buildSection9() {
    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        _buildSectionTitle('9. Reporting Phase'),
        _buildTextContent('Purpose: Deliver structured findings.'),
        const Text('Report Contents:', style: TextStyle(fontWeight: FontWeight.bold)),
        _buildBulletPoint('Executive Summary'),
        _buildBulletPoint('Scope'),
        _buildBulletPoint('Methodology'),
        _buildBulletPoint('Technical Findings'),
        _buildBulletPoint('Risk Ratings'),
        _buildBulletPoint('Remediation Steps'),
      ],
    );
  }

  Widget _buildSection10() {
    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        _buildSectionTitle('10. Debriefing Phase'),
        _buildTextContent('Purpose: Present results to stakeholders.'),
        _buildBulletPoint('Explain vulnerabilities'),
        _buildBulletPoint('Discuss business impact'),
        _buildBulletPoint('Provide recommendations'),
      ],
    );
  }

  Widget _buildSection11() {
    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        _buildSectionTitle('11. Remediation Phase'),
        _buildTextContent('Purpose: Fix identified issues.'),
        const Text('Typical Actions:', style: TextStyle(fontWeight: FontWeight.bold)),
        _buildBulletPoint('Patch outdated software'),
        _buildBulletPoint('Close unused ports'),
        _buildBulletPoint('Enforce strong passwords'),
        _buildBulletPoint('Harden configurations'),
      ],
    );
  }

  Widget _buildSection12(BuildContext context) {
    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        _buildSectionTitle('12. Retest Phase'),
        _buildTextContent('Purpose: Verify fixes.'),
        _buildCommandTile(context, 'Retest Command', 'nmap -sV $targetIp'),
        _buildTextContent('Compare results before and after remediation.'),
      ],
    );
  }

  Widget _buildSection13() {
    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        _buildSectionTitle('13. Final Reporting & Post‑Test Evaluation'),
        _buildTextContent('Purpose: Provide final confirmation.'),
        const Text('Includes:', style: TextStyle(fontWeight: FontWeight.bold)),
        _buildBulletPoint('Retest results'),
        _buildBulletPoint('Updated vulnerability status'),
        _buildBulletPoint('Final recommendations'),
      ],
    );
  }

  Widget _buildToolsSummary() {
    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        _buildSectionTitle('Tools Summary'),
        SingleChildScrollView(
          scrollDirection: Axis.horizontal,
          child: DataTable(
            columns: const [
              DataColumn(label: Text('Tool', style: TextStyle(fontWeight: FontWeight.bold))),
              DataColumn(label: Text('Purpose', style: TextStyle(fontWeight: FontWeight.bold))),
            ],
            rows: const [
              DataRow(cells: [DataCell(Text('ping')), DataCell(Text('Host availability'))]),
              DataRow(cells: [DataCell(Text('whois')), DataCell(Text('IP ownership'))]),
              DataRow(cells: [DataCell(Text('nslookup / host')), DataCell(Text('DNS lookup'))]),
              DataRow(cells: [DataCell(Text('nmap')), DataCell(Text('Port and vulnerability scanning'))]),
              DataRow(cells: [DataCell(Text('whatweb')), DataCell(Text('Web technology detection'))]),
              DataRow(cells: [DataCell(Text('nikto')), DataCell(Text('Web vulnerability scanning'))]),
              DataRow(cells: [DataCell(Text('sslscan')), DataCell(Text('SSL/TLS analysis'))]),
              DataRow(cells: [DataCell(Text('hydra')), DataCell(Text('Credential testing'))]),
              DataRow(cells: [DataCell(Text('msfconsole')), DataCell(Text('Exploitation framework'))]),
              DataRow(cells: [DataCell(Text('curl')), DataCell(Text('HTTP header checks'))]),
            ],
          ),
        ),
      ],
    );
  }

  Widget _buildCommandTile(BuildContext context, String title, String command) {
    return Card(
      margin: const EdgeInsets.symmetric(vertical: 6),
      elevation: 1,
      child: ExpansionTile(
        title: Text(title, style: const TextStyle(fontWeight: FontWeight.w600, fontSize: 15)),
        children: [
          Container(
            width: double.infinity,
            padding: const EdgeInsets.all(12),
            color: Colors.black87,
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                SelectableText(
                  command,
                  style: const TextStyle(color: Colors.greenAccent, fontFamily: 'Courier', fontWeight: FontWeight.bold),
                ),
                const SizedBox(height: 8),
                Align(
                  alignment: Alignment.centerRight,
                  child: TextButton.icon(
                    onPressed: () {
                      Clipboard.setData(ClipboardData(text: command));
                      ScaffoldMessenger.of(context).showSnackBar(
                        const SnackBar(content: Text('Command copied to clipboard'), duration: Duration(seconds: 1)),
                      );
                    },
                    icon: const Icon(Icons.copy, size: 16, color: Colors.white70),
                    label: const Text('Copy', style: TextStyle(color: Colors.white70)),
                  ),
                )
              ],
            ),
          ),
        ],
      ),
    );
  }
}
